<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.performance.dao.mapper.UserInfoDao">

    <resultMap id="resultMap" type="com.performance.pojo.UserInfo">
        <id property="loginId" column="login_id"/>
        <result property="userInfoId" column="user_info_id"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="loginName" column="login_name"/>
        <result property="password" column="password"/>
        <result property="idCard" column="id_card"/>
        <result property="userName" column="user_name"/>
        <result property="dispostion" column="dispostion"/>
        <result property="loginState" column="login_state"/>
        <result property="createdTime" column="created_time"/>
        <result property="modifiedTime" column="modified_time"/>
        <result property="createdUserInfoId" column="created_user_info_id"/>
        <result property="modifiedUserInfoId" column="modified_user_info_id"/>
    </resultMap>

    <resultMap id="userPerformanceResultMap" type="com.performance.pojo.UserInfoPerfor">
        <id property="loginId" column="login_id"/>
        <result property="userInfoId" column="user_info_id"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="loginName" column="login_name"/>
        <result property="password" column="password"/>
        <result property="idCard" column="id_card"/>
        <result property="userName" column="user_name"/>
        <result property="birthday" column="birthday"/>
        <result property="sex" column="sex"/>
        <result property="phone" column="phone"/>
        <result property="pid" column="pid"/>
        <result property="dispostion" column="dispostion"/>
        <result property="loginState" column="login_state"/>
        <result property="createdTime" column="created_time"/>
        <result property="modifiedTime" column="modified_time"/>
        <result property="createdUserInfoId" column="created_user_info_id"/>
        <result property="modifiedUserInfoId" column="modified_user_info_id"/>
        <association property="userPerformance" autoMapping="false" javaType="com.performance.pojo.UserPerformance">
            <id property="performanceId" column="performance_id"/>
            <result property="userInfoId" column="user_info_id"/>
            <result property="isDeleted" column="is_deleted"/>
            <result property="performanceContent" column="performance_content"/>
            <result property="performanceScore" column="performance_score"/>
            <result property="operateUserInfoId" column="operate_user_info_id"/>
            <result property="createdTime" column="created_time"/>
            <result property="modifiedTime" column="modified_time"/>
            <result property="isLocked" column="is_locked"/>
            <result property="operateDisposition" column="operate_disposition"/>
            <result property="performanceTime" column="performance_time"/>
        </association>
    </resultMap>

    <sql id="Base_Column_List">
        user_info_id,login_id,id_card,user_name,birthday,sex,phone,is_deleted,pid,dispostion,created_time,modified_time,created_user_info_id,modified_user_info_id
    </sql>

    <sql id="userPerformance_Base_Column_List">
        user_info.user_info_id,login_id,id_card,user_name,birthday,sex,phone,user_info.is_deleted,pid,dispostion,user_info.created_time,user_info.modified_time,created_user_info_id,modified_user_info_id,
        performance_id,performance_content,performance_score,operate_user_info_id,user_performance.created_time,user_performance.modified_time,is_locked,operate_disposition,performance_time
    </sql>

    <insert id="insert" parameterType="com.performance.pojo.UserInfo">
        INSERT INTO user_info (login_id,id_card,user_name,birthday,sex,phone,is_deleted,pid,dispostion,created_time,modified_time,created_user_info_id,modified_user_info_id)
        VALUES (#{loginId},#{idCard},#{userName},#{birthday}
        ,#{sex},#{phone},0,#{pid},#{dispostion},#{createdTime},#{modifiedTime}
        ,#{createdUserInfoId},#{modifiedUserInfoId});
    </insert>

    <select id="selectById" resultMap="resultMap" parameterType="java.lang.Long">
        SELECT
        <include refid="Base_Column_List"/>
        FROM user_info
        WHERE user_info_id = #{id} AND is_deleted=0;
    </select>

    <update id="updateById" parameterType="com.performance.pojo.UserInfo">
        UPDATE user_info SET
        <if test="loginId != null">login_id=#{loginId},</if>
        <if test="idCard != null">id_card=#{idCard},</if>
        <if test="userName != null">user_name=#{userName},</if>
        <if test="birthday != null">birthday=#{birthday},</if>
        <if test="sex != null">sex=#{sex},</if>
        <if test="phone != null">phone=#{phone},</if>
        <if test="isDeleted != null">is_deleted=#{isDeleted},</if>
--  NOTICE 父ID 拒绝修改 原因 会修改管理员的父ID 导致递归死循环问题 修改前 做好管理员信息修改处理
        <!--<if test="pid != null">pid=pid,</if>-->
        <if test="dispostion != null">dispostion=#{dispostion},</if>
        <if test="modifiedUserInfoId != null">modified_user_info_id=#{modifiedUserInfoId},</if>
        modified_time=now()
        <where>
            user_info_id=#{userInfoId} AND is_deleted=0;
        </where>
    </update>

    <select id="selectAllChild" parameterType="java.lang.Long" resultMap="resultMap" resultType="List">
        SELECT
         <include refid="Base_Column_List"/>
         FROM user_info
            WHERE pid in
            (
                (
                    SELECT user_info_id FROM user_info
                    WHERE pid in
                    (SELECT user_info_id FROM user_info
                    WHERE pid=#{userInfoId})
                )
                UNION
                    (SELECT user_info_id FROM user_info
                    WHERE pid=#{userInfoId})
                UNION
                    SELECT #{userInfoId}
            )
            AND is_deleted=0;
    </select>

    <select id="containsChild" parameterType="Map" resultType="com.performance.pojo.UserInfo">
        SELECT
        <include refid="Base_Column_List"/>
        FROM user_info
        WHERE pid in
            (
                (
                    SELECT user_info_id FROM user_info
                    WHERE pid in
                    (SELECT user_info_id FROM user_info
                    WHERE pid=#{parent})
                )
                UNION
                    (SELECT user_info_id FROM user_info
                    WHERE pid=#{parent})
                UNION
                    SELECT #{parent}
            )
            AND user_info_id = #{child}
            AND is_deleted=0;
    </select>

    <select id="selectForPage" parameterType="com.performance.common.query.UserInfoPageParam"
            resultMap="userPerformanceResultMap">
        SELECT
        <include refid="userPerformance_Base_Column_List"/>
        FROM user_info
        LEFT JOIN user_performance
        ON user_info.user_info_id = user_performance.user_info_id
        <where>
            <if test="performanceTime != null and performanceTime != ''">
                user_performance.performance_time = #{performanceTime}
            </if>
            AND user_info.user_info_id IN
            <foreach collection="infoIds" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
            AND user_performance.is_deleted = 0
            AND user_info.is_deleted = 0
        </where>
        <if test="orderField != null and orderDir != null and orderField != '' and orderDir != ''">
            ORDER BY ${orderField} ${orderDir}
        </if>
        limit #{offset},#{limit}
    </select>

    <select id="selectPageCount" resultType="java.lang.Long" parameterType="com.performance.common.query.UserInfoPageParam">
        SELECT count(1) FROM user_info
        LEFT JOIN user_performance
        ON user_info.user_info_id = user_performance.user_info_id
        <where>
            <if test="performanceTime != null and performanceTime != ''">
                user_performance.performance_time = #{performanceTime}
            </if>
            AND user_info.user_info_id IN
            <foreach collection="infoIds" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
            AND user_performance.is_deleted = 0
            AND user_info.is_deleted = 0
        </where>
    </select>

    <select id="selectCount" resultType="java.lang.Integer"
            parameterType="com.performance.pojo.UserInfo">
        SELECT count(1) FROM user_info
        WHERE is_deleted=0;
    </select>

    <select id="selectForIdsByParam" parameterType="java.util.List" resultType="java.lang.Long">
        SELECT user_info_id FROM  user_info WHERE pid in
        <foreach collection="list" index="index" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
        AND is_deleted=0;
    </select>

</mapper>